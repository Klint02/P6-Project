<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Test virker</h1>

    <p id="Test0"></p>
    <p id="Test1"></p>
    <p id="Test2"></p>
    <p id="Test3"></p>
    <p id="Test4"></p>

    <div class="test">
        <h1>Servers List</h1>
        <ul id="serverList"></ul>

    </div>

</body>
<script>
    //Fetcher data fra energinet api og ligger det over i variablen 'data'.
    var data = fetch('https://api.energidataservice.dk/dataset/PowerSystemRightNow?limit=1').then((response) => response.json()).then((data => {
        //printer json filen i consollen så for få et overblik.
        console.log(data)
        //for-loop der går igennem de forskellige arrays der er i json filen.
        for (let i = 0; i < data.records.length; i++) {
            //laver en text variabel der skal bruges til at display tabellerne.
            let text = "<table border='1' width='300' style='float: left;margin: 1em'>"
            //for-loop der gennemgår alle atributter inde i hver array, og laver en tabel med 2 kolonner, den ene er atributtens navn og den anden er værdien.
            //dataen bliver så lagt ind i variablen text.
            for (let x in data.records[i]) {
                text += "<tr><td>" + x + "</td><td>" + data.records[i][x] + "</td></tr>";
            }
            //closing-tag til text variablen.
            text += "</table>"
            //Det sidste den gør er at loop sætte den respetive tabel og sætter den ind i det html-id der er ovenfor.
            document.getElementById(`Test${i}`).innerHTML = text;
        }
    }))

    // Function to load the array of servers from the server
    async function loadServers() {
    try {
        const response = await fetch('api/servers'); 
        const servers = await response.json();
        let serverID = 0;

        const list = document.getElementById('serverList'); 
        servers.forEach(server => {

            const item = document.createElement('li');
            item.textContent = `${'Server Name:'} ${server.name} - ${'\nServer state:'} 
            ${server.state} - ${'Last known percantage:'} ${server.lastKnownPercantage} ${'%'} `;
            item.id = `server${serverID++}`;
            
            const changeStateButton = document.createElement('button');
            changeStateButton.textContent = 'Change state';
            changeStateButton.addEventListener('click', () => {
                changeServerState(server.name);
            });

            item.appendChild(changeStateButton);
            list.appendChild(item); 

        });

    } catch(error) {
        console.log('Error fetching servers', error);
    }
}

async function changeServerState(serverName){
    const newState = prompt(`Enter new state for ${serverName}:`); 

    try {
        const response = await fetch(`api/servers/${serverName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ state: newState })
        });

        if(response.ok) {
            console.log(`Server state updated for ${serverName}`);
            document.getElementById('serverList').innerHTML = '';
            loadServers();
        } else {
            console.error('Failed to change server state');
        }

    } catch(error) {
        console.error('Error changing server state', error);
    }
}

window.onload = loadServers;
</script>

</html>