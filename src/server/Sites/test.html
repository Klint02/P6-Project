<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Test virker</h1>

    <p id="Test0"></p>
    <p id="Test1"></p>
    <p id="Test2"></p>
    <p id="Test3"></p>
    <p id="Test4"></p>

    <div class="test">
        <h1>Servers List</h1>
        <ul id="serverList"></ul>

    </div>

</body>
<script>
    //Fetcher data fra energinet api og ligger det over i variablen 'data'.
    var data = fetch('https://api.energidataservice.dk/dataset/PowerSystemRightNow?limit=1').then((response) => response.json()).then((data => {
        //printer json filen i consollen så for få et overblik.
        console.log(data)
        //for-loop der går igennem de forskellige arrays der er i json filen.
        for (let i = 0; i < data.records.length; i++) {
            //laver en text variabel der skal bruges til at display tabellerne.
            let text = "<table border='1' width='300' style='float: left;margin: 1em'>"
            //for-loop der gennemgår alle atributter inde i hver array, og laver en tabel med 2 kolonner, den ene er atributtens navn og den anden er værdien.
            //dataen bliver så lagt ind i variablen text.
            for (let x in data.records[i]) {
                text += "<tr><td>" + x + "</td><td>" + data.records[i][x] + "</td></tr>";
            }
            //closing-tag til text variablen.
            text += "</table>"
            //Det sidste den gør er at loop sætte den respetive tabel og sætter den ind i det html-id der er ovenfor.
            document.getElementById(`Test${i}`).innerHTML = text;
        }
    }))

    // Function to load the array of servers from the server
    async function loadServers() {
    try {
        const response = await fetch('api/servers'); 
        const servers = await response.json();
        let serverID = 0;

        // Get the list element
        const list = document.getElementById('serverList'); 
        // Clear the list
        list.innerHTML = '';
        // Loop through the servers
        servers.forEach(server => {
            // Create a new list item for each server
            const item = document.createElement('li');
            item.textContent = `${'Server Name:'} ${server.name} - ${'\nServer state:'} 
            ${server.state} - ${'Last known percantage:'} ${server.lastKnownPercantage + '%'}  `;
            item.id = `server${serverID++}`;
            
            // Create a dropdown menu to change the state of the server
            const options = ["not init" ,"idle", "running"];
            const changeStateSelect = document.createElement('select',options);
            
            // Create a dropdown menu with the possible states
            options.forEach(optionValue => {
                const optionElement = document.createElement('option');
                optionElement.value = optionValue;
                optionElement.textContent = optionValue;
                optionElement.selected = server.state === optionValue;
                changeStateSelect.appendChild(optionElement);
            });

            changeStateSelect.addEventListener('change',() => {
                changeServerState(server.name, changeStateSelect.value);
            });
           
            item.appendChild(document.createTextNode('Change to: '))
            item.appendChild(changeStateSelect);
            list.appendChild(item); 

        });

    } catch(error) {
        console.log('Error fetching servers', error);
    }
}

// Function to change the state of a server
async function changeServerState(serverName, newState){
    try {
        // Send a POST request to the server to change the state
        const response = await fetch(`api/servers/${encodeURIComponent(serverName)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ state: newState })
        });
        // If the request was successful, reload the server list
        if(response.ok) {
            console.log(`Server state updated for ${serverName}`);
           // document.getElementById('serverList').innerHTML = '';
            loadServers();
        } 
        // if the request was not succesful log an error
        else {
            console.error('Failed to change server state');
            alert('Failed to change server state');
        }

    } 
    catch(error) {
        console.error('Error changing server state', error);
        alert('Error changing server state');
    }
}

window.onload = loadServers;
</script>

</html>