<div id="serverList">

</div>


<script>
    let server_list_component_requests = [];
    let servers;
    let selected_server;
    // Function to load the array of servers from the server
async function loadServers() {
    try {
        const response = await fetch('api/servers');
        servers = await response.json();
        
        const list = document.getElementById('serverList');
        let serverList = '';
        servers.forEach((server, index) => {
            let class_modifier = "";
            let component_modifier = `add_components_to_DOM(server_list_component_requests[${index}]), selected_server = "${server.IP}"`
            // Create a new list item for each server
            if (server.IP == selected_server) {
                class_modifier = "-selected"
                component_modifier = `add_components_to_DOM(server_controls_component), selected_server = ""`

            }
            server_list_component_requests.push([{
                    "type": "non-shared",
                    "name": "client_frame.html",
                    "placement": document.getElementById("column-left-top-frame"),
                    "tags": [{"serverURL": `"${server.IP}"`}, {"client_name": `${server.Name}` }],
                    "serverURL": `${server.IP}`
                }]);
            serverList += `<div class="pane-border${class_modifier} pane-servers" style="">
                                <div class="pane-servers-topbar">
                                    <div> ${server.Name} </div>
                                    <button id="${server.IP}-button" class="pane-servers-status ${server.State}" onclick="changeServerState('${server.Name}','${server.IP}-button')"></button> 
                                </div>
                                <div class="pane-servers-body" onclick='${component_modifier}, loadServers()'>
                                    status: ${server.State}
                                    <br> 
                                    Current fill: ${server.LastKnownPercentage}% 
                                    <br> 
                                    URL: ${server.IP}
                                </div>
                            </div>`
        });

        list.innerHTML = serverList;
    } catch (error) {
        console.log('Error fetching servers', error);
    }
}

async function changeServerState(serverName, elementID){ 
    const element = document.getElementById(elementID); 
    let server_state;
    servers.forEach(server =>{
        if (server.Name == serverName) {
            if (server.State != "not_init") {
                server_state = "not_init";
            } else {
                server_state = "idle";
            }
        }
    });

    const data = { 
        "Name": serverName, 
        "State": server_state
    }; 
    
    const response = await fetch('/api/updateServers', { 
        method: 'POST', 
        headers: { 
            'Content-Type': 'application/json' 
        }, 
        body: JSON.stringify(data)
    });
    if (response) {
        loadServers();
    }
}

loadServers()


</script>