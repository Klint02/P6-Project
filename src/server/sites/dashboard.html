<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/shared/styles/styles.css">
  </head>
<style>
    
    .serverList {
        list-style-type: none;
        margin: 4px;
        padding: 0;
        height:100%;
        
    }


</style>

<body>
    <div id="content-body">
        <div id="column-left-top" class="pane">
            <h2 class="pane-topbar">
                Dashboards
            </h2>
            <div id="column-left-top-frame" class="frame"></div>
        </div>
        <div id="column-left-bottom" class="pane">
            <h2 class="pane-topbar">
                Energy data
            </h2>
            <div id="column-left-bottom-frame" class="frame"></div>
        </div>
        <div id="column-right" class="pane">
            <h2 class="pane-topbar">
                Servers
            </h2>
            <div id="column-right-frame" class="frame"></div>
        </div>
    </div>

</body>

</html>

<script>
    //TODO: change from relative paths to absolute, do this dynamically
    async function fetch_component(url, components) {
        const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify(components),
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Content-type": "application/json; charset=UTF-8"
            }
        })

        const data = response.json();

        return data;
    }

    function request_sorter(components_request) {
        let request_map = new Map();
        components_request.forEach((request) => {
            if (!request_map.has(request["serverURL"])) {
                request_map.set(request["serverURL"], []);
            }
            request_map.get(request["serverURL"]).push(request);
        })
        return request_map;
    }
    async function add_components_from_server(url, components) {
        let components_fetched = await fetch_component(url, components);
        components_fetched.forEach((component, index) => {
            if (index == 0) {
                components[index]["placement"].innerHTML = "";
            }
            components[index]["placement"].insertAdjacentHTML( 'beforeend', component["html"]);
            let script = document.createElement('script');
            script.textContent = component["js"];
            components[index]["placement"].appendChild(script);           
            
        });      

    }

    async function add_components_to_DOM(components_request) {
        let components_promised;
        let components_request_sorted = request_sorter(components_request);
        components_request_sorted.forEach((element, key) => {
            if (key != "") {
                add_components_from_server(`http://${key}/fetch/component`, element);
            } else {
                add_components_from_server(`/fetch/component`, element);
            }
            
        });
    }

    document.addEventListener("DOMContentLoaded", async function() {
        
        let components = [
                {
                    "type": "non-shared",
                    "name": "client_frame.html",
                    "placement": document.getElementById("column-left-top-frame"),
                    "tags": [{"serverURL": "\"192.120.0.3:8083\"" }],
                    "serverURL": "192.120.0.3:8083"
                },
                {
                    "type": "non-shared",
                    "name": "serverList.html",
                    "placement": document.getElementById("column-right-frame"),
                    "tags": [],
                    "serverURL": ""
                },
                
            ]
            add_components_to_DOM(components);
        //add_component_to_DOM(document.getElementById("column2"), "/internal/db_controls");
        //add_component_to_DOM(document.getElementById("column-left"), "/components/test");
        //add_component_to_DOM(document.getElementById("column-right"), "/components/serverList");
    })
</script>