<!DOCTYPE html>
<html>
<style>
    
    .serverList {
        list-style-type: none;
        margin: 4px;
        padding: 0;
        height:100%;
        
    }
    .component_holder{
        border: 1px solid #555;
        border-radius: 5px;
        margin: 4px;
        padding: 10px;
    }

</style>

<body>

    <div id="row" style="display:flex">
        <div class ="component_holder" id="column-left" style="width: 80%;">
            <div  style="display: flex; height: 600px;">
                <h1>Random ass graf</h1>
            </div>
        <div id="table-scroll">
            <p id="Test0"></p>
        </div>
        </div>
        
            



        <div class="component_holder" id="column-right" style="width:20%;">    
                <ul class="serverList"></ul>
        </div>
    </div>


</body>

</html>

<script>
    //TODO: change from relative paths to absolute, do this dynamically
    async function fetch_component(url, components) {
        const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify(components),
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Content-type": "application/json; charset=UTF-8"
            }
        })

        const data = response.json();

        return data;
    }

    function request_sorter(components_request) {
        let request_map = new Map();
        components_request.forEach((request) => {
            if (!request_map.has(request["serverURL"])) {
                request_map.set(request["serverURL"], []);
            }
            request_map.get(request["serverURL"]).push(request);
        })
        return request_map;
    }
    async function add_components_from_server(url, components) {
        let components_fetched = await fetch_component(url, components);
        components_fetched.forEach((component, index) => {
            if (index == 0) {
                components[index]["placement"].innerHTML = "";
            }
            components[index]["placement"].insertAdjacentHTML( 'beforeend', component["html"]);
            let script = document.createElement('script');
            script.textContent = component["js"];
            components[index]["placement"].appendChild(script);           
            
        });      

    }

    async function add_components_to_DOM(components_request) {
        let components_promised;
        let components_request_sorted = request_sorter(components_request);
        components_request_sorted.forEach((element, key) => {
            if (key != "") {
                add_components_from_server(`http://${key}/fetch/component`, element);
            } else {
                add_components_from_server(`/fetch/component`, element);
            }
            
        });
    }

    document.addEventListener("DOMContentLoaded", async function() {
            let components = [
                {
                    "type": "non-shared",
                    "name": "client_frame.html",
                    "placement": document.getElementById("column-left"),
                    "tags": [{"serverURL": "\"192.120.0.3:8083\"" }],
                    "serverURL": "192.120.0.3:8083"
                },
                {
                    "type": "non-shared",
                    "name": "serverList.html",
                    "placement": document.getElementById("column-right"),
                    "tags": [],
                    "serverURL": ""
                }
            ]
            add_components_to_DOM(components);
  
        //add_component_to_DOM(document.getElementById("column2"), "/internal/db_controls");
        //add_component_to_DOM(document.getElementById("column-left"), "/components/test");
        //add_component_to_DOM(document.getElementById("column-right"), "/components/serverList");
    })
</script>